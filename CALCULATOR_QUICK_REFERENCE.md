# –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - –ë—ã—Å—Ç—Ä–∞—è –°–ø—Ä–∞–≤–∫–∞ üöÄ

## üìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∫–æ–¥?

| –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|---------|
| `app/Support/ProductAttributeCalculator.php` | 1-188 | –ì–ª–∞–≤–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á—ë—Ç–æ–≤ |
| `app/Models/ProductTemplate.php` | 68-311 | –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª –∏ –ø–∞—Ä—Å–∏–Ω–≥ –≤—ã—Ä–∞–∂–µ–Ω–∏–π |
| `app/Filament/Resources/ReceiptResource.php` | 186-238, 573-642 | –§–æ—Ä–º–∞ –ø—Ä–∏—ë–º–∫–∏ —Ç–æ–≤–∞—Ä–∞ |
| `app/Filament/Resources/SaleResource.php` | 61-78 | –§–æ—Ä–º–∞ —Ä–∞—Å—á—ë—Ç–∞ —Å—É–º–º—ã –ø—Ä–æ–¥–∞–∂–∏ |
| `app/Models/Product.php` | - | –ú–æ–¥–µ–ª—å —Ç–æ–≤–∞—Ä–∞ |
| `app/Models/Sale.php` | - | –ú–æ–¥–µ–ª—å –ø—Ä–æ–¥–∞–∂–∏ |

---

## üéØ –í–æ–ø—Ä–æ—Å ‚Üí –û—Ç–≤–µ—Ç (QA)

### Q: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±—ä—ë–º–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏?
**A:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "50,5")
2. Livewire –∂–¥—ë—Ç 400ms –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (`debounce: 400`)
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `afterStateUpdated` ‚Üí `calculateVolumeForItem()`
4. –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ `ProductAttributeCalculator::calculateAndUpdate()`
5. –ê—Ç—Ä–∏–±—É—Ç—ã –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è (`50,5` ‚Üí `50.5`)
6. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `ProductTemplate::testFormula()` —Å —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
7. –§–æ—Ä–º—É–ª–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –ø–∞—Ä—Å–µ—Ä–æ–º (–Ω–µ `eval()`)
8. –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–æ–ª–µ "–û–±—ä–µ–º" (readonly)

---

### Q: –ö–∞–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —á–∏—Å–ª–∞–º–∏?
**A:**
```php
// –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å:
'attribute_width' => '50,5'     // –∑–∞–ø—è—Ç–∞—è –≤–º–µ—Å—Ç–æ —Ç–æ—á–∫–∏
'attribute_height' => '2.5'     // —Ç–æ—á–∫–∞ (–Ω–æ—Ä–º–∞)
'attribute_length' => '200'     // —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ

// –ü–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
$normalizedValue = str_replace(',', '.', $value);
// –†–µ–∑—É–ª—å—Ç–∞—Ç: ['width' => 50.5, 'height' => 2.5, 'length' => 200.0]
```

---

### Q: –ß—Ç–æ —Ç–∞–∫–æ–µ "is_in_formula" –∏ –∫–∞–∫ –æ–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–º—è —Ç–æ–≤–∞—Ä–∞?
**A:**
- **is_in_formula = true**: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –§–û–†–ú–£–õ–ï —Ä–∞—Å—á—ë—Ç–∞
  - –ü—Ä–∏–º–µ—Ä: length, width, height (–¥–ª—è –æ–±—ä—ë–º–∞)
  - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏–º–µ–Ω–∏ —Å –∫—Ä–µ—Å—Ç–∏–∫–∞–º–∏: "–î–æ—Å–∫–∞: 200 x 50.5 x 2.5"
  
- **is_in_formula = false**: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ù–ï —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ñ–æ—Ä–º—É–ª–µ
  - –ü—Ä–∏–º–µ—Ä: wood_type, surface_type (–æ–ø–∏—Å–∞–Ω–∏–µ)
  - –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∏–º–µ–Ω–∏ —Å –∑–∞–ø—è—Ç—ã–º–∏: "–î–æ—Å–∫–∞: 200 x 50.5 x 2.5, –°–æ—Å–Ω–∞"

---

### Q: –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞ —Ç–æ–≤–∞—Ä–∞?
**A:**
```php
// –í —Ç–∞–±–ª–∏—Ü–µ product_templates
// –ü–æ–ª–µ: formula
// –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è: "length * width * height / 1000"

// –¢–∞–±–ª–∏—Ü–∞: product_templates
// –°—Ç–æ–ª–±—Ü—ã:
// - id
// - name (–î–æ—Å–∫–∞)
// - formula (length * width * height / 1000)
// - unit (–º¬≥)
// - description
// - is_active
```

---

### Q: –ö–∞–∫ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞? –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ eval()?
**A:**
**–ù–ï–¢**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–ï–ó–û–ü–ê–°–ù–´–ô —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–∞—Ä—Å–µ—Ä:

```php
// –ù–ï–ë–ï–ó–û–ü–ê–°–ù–´–ô —Å–ø–æ—Å–æ–± (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ ReceiptResource):
$result = eval("return $expression;");  // ‚ùå –û–ü–ê–°–ù–û!

// –ë–ï–ó–û–ü–ê–°–ù–´–ô —Å–ø–æ—Å–æ–± (ProductTemplate::testFormula):
$result = $this->evaluateExpression($expression);  // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û
  ‚îÇ
  ‚îú‚îÄ validateExpression() - –ø—Ä–æ–≤–µ—Ä–∫–∞ regex
  ‚îÇ  ‚îî‚îÄ /^[0-9+\-*\/\(\)\.]+$/ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã)
  ‚îÇ
  ‚îú‚îÄ parseExpression() - –ø–∞—Ä—Å–∏–Ω–≥ —Å–æ —Å–∫–æ–±–∫–∞–º–∏
  ‚îÇ
  ‚îî‚îÄ evaluateExpressionRecursive() - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ
     ‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–æ–±–æ–∫
     ‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ * –∏ / (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1)
     ‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∫–∞ + –∏ - (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2)
     ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—Ç —á–∏—Å–ª–æ–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
```

---

### Q: –ß—Ç–æ —Ç–∞–∫–æ–µ "debounce" –∏ –ø–æ—á–µ–º—É –æ–Ω –Ω—É–∂–µ–Ω?
**A:**
```php
->live(debounce: 400)  // –ó–∞–¥–µ—Ä–∂–∫–∞ 400ms –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

// –°—Ü–µ–Ω–∞—Ä–∏–π –ë–ï–ó debounce:
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç "200" (3 —Å–∏–º–≤–æ–ª–∞)
// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è 3 AJAX-–∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
// –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω, –º–µ–¥–ª–µ–Ω–Ω–æ ‚úó

// –°—Ü–µ–Ω–∞—Ä–∏–π –° debounce: 400ms
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç "200" (3 —Å–∏–º–≤–æ–ª–∞ –∑–∞ 100ms)
// –°–∏—Å—Ç–µ–º–∞ –∂–¥—ë—Ç 400ms –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–º–≤–æ–ª–∞
// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è 1 AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è "200"
// –°–µ—Ä–≤–µ—Ä —Å–ø–æ–∫–æ–π–Ω–æ, –±—ã—Å—Ç—Ä–æ ‚úì
```

---

### Q: –ö–∞–∫–∞—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö?
**A:**
```php
// –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:
->live(debounce: 400)
// ‚úì –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø—Ä–∏ –≤–≤–æ–¥–µ —Ä–∞–∑–º–µ—Ä–æ–≤
// ‚úó –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–Ω–æ–≥–æ calculs if —á–∏—Å–ª–∞ –º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–æ

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ü—Ä–æ–¥–∞–∂–∞):
->live(debounce: 400)  # ‚Üê –û–ë–ù–û–í–õ–ï–ù–û: –±—ã–ª–æ live(onBlur: true)
```

---

## üíª Copy-Paste –ö–æ–¥

### –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –í—ã–∑–æ–≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞

```php
// –í afterStateUpdated() –º–µ—Ç–æ–¥–∞ –ø–æ–ª—è:
->afterStateUpdated(function (Set $set, Get $get) {
    $templateId = $get('product_template_id');
    $quantity = $get('quantity');
    $formData = $get();
    
    ProductAttributeCalculator::calculateAndUpdate($set, $formData, $templateId, $quantity);
})
```

### –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—è—Ç—ã—Ö/—Ç–æ—á–µ–∫

```php
// –î–ª—è –ª—é–±–æ–≥–æ —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è:
$normalizedValue = is_string($value) 
    ? str_replace(',', '.', $value) 
    : $value;

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ü–µ–ª–æ–º —á–∏—Å–ª–µ:
$numericAttributes = [];
foreach ($attributes as $key => $value) {
    if (is_numeric($value) && $value > 0) {
        $numericAttributes[$key] = (float) $value;
    }
}
```

### –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –í–∞–ª–∏–¥–∞—Ü–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –ø–æ–ª—è

```php
TextInput::make('attribute_width')
    ->label('–®–∏—Ä–∏–Ω–∞ (—Å–º)')
    ->inputMode('decimal')
    ->maxLength(10)
    ->required($attribute->is_required)
    ->rules(['regex:/^\d*([.,]\d*)?$/'])  // ‚Üê –í–∞–ª–∏–¥–∞—Ü–∏—è
    ->validationMessages([
        'regex' => '–ü–æ–ª–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –æ–¥–Ω—É –∑–∞–ø—è—Ç—É—é –∏–ª–∏ —Ç–æ—á–∫—É',
    ])
    ->live(debounce: 400)
    ->afterStateUpdated(function (Set $set, Get $get) {
        self::calculateVolumeForItem($set, $get);
    })
```

### –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å: –†–∞—Å—á—ë—Ç —Å—É–º–º—ã –≤ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

```php
private static function calculateTotalPrice(Set $set, Get $get): void
{
    $cashRaw = (string) ($get('cash_amount') ?? '0');
    $nocashRaw = (string) ($get('nocash_amount') ?? '0');
    
    $cashAmount = (float) str_replace(',', '.', $cashRaw);
    $nocashAmount = (float) str_replace(',', '.', $nocashRaw);
    $totalPrice = $cashAmount + $nocashAmount;
    
    $set('total_price', $totalPrice);
    
    Log::info('Sale form: calculateTotalPrice', [
        'cash_amount' => $cashAmount,
        'nocash_amount' => $nocashAmount,
        'total_price' => $totalPrice,
    ]);
}
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä?

1. **–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)**
2. **–í–∫–ª–∞–¥–∫–∞ Network**
3. **–í–≤–æ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏**
4. **–ò—â–∏—Ç–µ AJAX-–∑–∞–ø—Ä–æ—Å "wire" (Livewire)**
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Response - –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å calculated_volume**

### –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Ä–∞—Å—á—ë—Ç–∞?

```php
// storage/logs/laravel.log

// –ü–æ–∏—Å–∫ –ª–æ–≥–æ–≤:
tail -f storage/logs/laravel.log | grep "Volume calculated"
tail -f storage/logs/laravel.log | grep "Sale form"
```

### –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É?

1. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å ‚Üí –®–∞–±–ª–æ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤**
2. **–û—Ç–∫—Ä–æ–π—Ç–µ —à–∞–±–ª–æ–Ω**
3. **–í–Ω–∏–∑—É –∫–Ω–æ–ø–∫–∞ "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É"**
4. **–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ**

---

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –û—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞ 1: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤ –≤ —Å—É–º–º–∞—Ö

```php
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
$cashAmount = (float) str_replace(',', '.', '1 000,00');
// –†–µ–∑—É–ª—å—Ç–∞—Ç: (float) '1 000.00' = 1.0 ‚Üê –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
$cashAmount = (float) str_replace([' ', ','], [''  , '.'], '1 000,00');
// –†–µ–∑—É–ª—å—Ç–∞—Ç: (float) '1000.00' = 1000.0 ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û!
```

### –û—à–∏–±–∫–∞ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ eval()

```php
// ‚ùå –û–ü–ê–°–ù–û:
$result = eval("return $expression;");

// ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û:
$result = $template->testFormula($attributes);
```

### –û—à–∏–±–∫–∞ 3: –ó–∞–±—ã–ª–∏ debounce –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–µ

```php
// ‚ùå –ë–ï–ó DEBOUNCE (–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤):
->live()  // –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∏–º–≤–æ–ª–µ

// ‚úÖ –° DEBOUNCE (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ):
->live(debounce: 400)  // –∂–¥—ë—Ç 400ms
```

### –û—à–∏–±–∫–∞ 4: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π

```php
// –§–æ—Ä–º—É–ª–∞: "2 + 3 * 4"
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: 2 + 3 * 4 = 5 * 4 = 20
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: 2 + 3 * 4 = 2 + 12 = 14
// –ü—Ä–∏—á–∏–Ω–∞: * –∏–º–µ–µ—Ç –±–æ–ª—å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª:** `CALCULATOR_MECHANISM.md` - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **–≠—Ç–æ—Ç —Ñ–∞–π–ª:** `CALCULATOR_QUICK_REFERENCE.md` - –±—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞
- **API Docs:** Check `API_DOCUMENTATION.md` for endpoints

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç –¥–ª—è ProductTemplate::testFormula()

```php
public function test_product_template_formula_calculation(): void
{
    $template = ProductTemplate::factory()
        ->has(ProductAttribute::factory()->count(3))
        ->create([
            'formula' => 'length * width * height / 1000',
        ]);
    
    $result = $template->testFormula([
        'length' => 200,
        'width' => 50,
        'height' => 2,
    ]);
    
    $this->assertTrue($result['success']);
    $this->assertEquals(20.0, $result['result']);
}
```

### Feature —Ç–µ—Å—Ç –¥–ª—è ReceiptResource

```php
public function test_receipt_resource_calculates_volume(): void
{
    $template = ProductTemplate::factory()
        ->has(ProductAttribute::factory()->count(3))
        ->create(['formula' => 'length * width * height / 1000']);
    
    livewire(CreateReceipt::class)
        ->fillForm([
            'product_template_id' => $template->id,
            'quantity' => 10,
            'attribute_length' => '200',
            'attribute_width' => '50',
            'attribute_height' => '2',
        ])
        ->assertSee('20.000')  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä—ë–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω
        ->call('create')
        ->assertRedirect();
}
```

---

## üéì –û–±—É—á–µ–Ω–∏–µ –Ω–æ–≤–∏—á–∫–æ–≤

### –®–∞–≥ 1: –ü–æ–Ω—è—Ç—å –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ "–î–ò–ê–ì–†–ê–ú–ú–ê 1" –≤ `CALCULATOR_MECHANISM.md`

### –®–∞–≥ 2: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
- –û—Ç–∫—Ä–æ–π—Ç–µ `app/Support/ProductAttributeCalculator.php`
- –ù–∞–π–¥–∏—Ç–µ –º–µ—Ç–æ–¥ `calculateAndUpdate()`
- –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –∫–∞–∂–¥—ã–π —à–∞–≥ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö

### –®–∞–≥ 3: Trace through the code
```bash
# –í productInTransitResource.php –Ω–∞–π–¥–∏—Ç–µ:
private static function calculateVolumeForItem(Set $set, Get $get): void
{
    # –≠—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
}

# –ß—Ç–æ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç:
# 1. –ü–æ–ª—É—á–∞–µ—Ç templateId
# 2. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
# 3. –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
# 4. –í—ã–∑—ã–≤–∞–µ—Ç ProductAttributeCalculator::calculateAndUpdate()
```

### –®–∞–≥ 4: –ü—Ä–∞–∫—Ç–∏–∫–∞
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω —Ç–æ–≤–∞—Ä–∞ —Å —Ñ–æ—Ä–º—É–ª–æ–π
2. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –ø—Ä–∏—ë–º–∫—É
3. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ AJAX –∑–∞–ø—Ä–æ—Å—ã
4. –ù–∞–±–ª—é–¥–∞–π—Ç–µ, –∫–∞–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è calculated_volume
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f storage/logs/laravel.log`

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã

```
ProductAttributeCalculator (main logic)
    ‚Üì
ProductTemplate (formula parsing & evaluation)
    ‚Üì
ProductAttribute (characteristic definitions)
    ‚Üì
Product (storage of calculated values)
    ‚Üì
ReceiptResource / SaleResource (UI forms)
    ‚Üì
Livewire (real-time updates)
```

---

## üí° Pro Tips

1. **–ö–µ—à–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω—ã**, –µ—Å–ª–∏ –º–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–æ–≤:
   ```php
   private static array $templateCache = [];
   ```

2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ –≤ debug —Ä–µ–∂–∏–º–µ**, –Ω–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:
   ```php
   if (config('app.debug')) {
       Log::debug('Volume calculated', [...]);
   }
   ```

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ transactions –¥–ª—è atomic saves**:
   ```php
   DB::transaction(function () {
       Product::create($data);
       // –£–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∏–ª–∏ –Ω–∏—á–µ–≥–æ
   });
   ```

4. **–î–æ–±–∞–≤—å—Ç–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–æ–≤:
   ```php
   $cacheKey = md5(json_encode($numericAttributes));
   $result = Cache::remember($cacheKey, 3600, fn () => $template->testFormula(...));
   ```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** October 19, 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** AI Assistant

> **–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –í –≤–µ—Ä—Å–∏–∏ –æ—Ç 19.10.2025 —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ `live(debounce: 400)` –¥–ª—è –æ–±–æ–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ (–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è). –†–∞–Ω–µ–µ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `live(onBlur: true)`, –Ω–æ —ç—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –ª—É—á—à–µ–≥–æ UX. –¢–µ–ø–µ—Ä—å —Ä–∞—Å—á—ë—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–ª–∏–∫–∞—Ç—å.

