# Документация: Формирование поля `name` из атрибутов товара

## Обзор

Поле `name` товара автоматически генерируется на основе атрибутов шаблона товара (`ProductTemplate`) и заполненных значений характеристик. Система использует интеллектуальную логику для создания читаемых и структурированных названий.

## Принцип работы

### 1. Базовые компоненты

- **Шаблон товара** (`ProductTemplate`) - содержит название шаблона (например, "Доска", "Профиль")
- **Атрибуты шаблона** (`ProductAttribute`) - характеристики товара с настройками
- **Значения атрибутов** - конкретные значения, введенные пользователем

### 2. Типы атрибутов

Атрибуты делятся на два типа по их роли в формировании имени:

#### Формульные атрибуты (`is_in_formula = true`)
- Используются в математических формулах для расчета объема
- В названии объединяются через символ ` x ` (умножение)
- Пример: длина, ширина, высота

#### Обычные атрибуты (`is_in_formula = false`)
- Дополнительные характеристики товара
- В названии объединяются через запятую
- Пример: сорт, цвет, производитель

### 3. Типы данных атрибутов

- **`number`** - числовые значения (длина, ширина, количество)
- **`text`** - текстовые значения (описание, примечания)
- **`select`** - значения из предопределенного списка

## Алгоритм формирования имени

### Шаг 1: Сбор атрибутов
```php
// Собираем все заполненные атрибуты
$attributes = [];
foreach ($template->attributes as $templateAttribute) {
    $attributeKey = $templateAttribute->variable;
    if ($templateAttribute->type !== 'text' && 
        isset($inputAttributes[$attributeKey]) && 
        $inputAttributes[$attributeKey] !== null && 
        $inputAttributes[$attributeKey] !== '') {
        
        if ($templateAttribute->is_in_formula) {
            $formulaParts[] = $inputAttributes[$attributeKey];
        } else {
            $regularParts[] = $inputAttributes[$attributeKey];
        }
    }
}
```

### Шаг 2: Формирование частей названия
```php
$templateName = $template->name ?? 'Товар';
$generatedName = $templateName;

// Добавляем формульные части
if (!empty($formulaParts)) {
    $generatedName .= ': ' . implode(' x ', $formulaParts);
}

// Добавляем обычные части
if (!empty($regularParts)) {
    if (!empty($formulaParts)) {
        $generatedName .= ', ' . implode(', ', $regularParts);
    } else {
        $generatedName .= ': ' . implode(', ', $regularParts);
    }
}
```

## Примеры формирования

### Пример 1: Доска с формульными и обычными атрибутами

**Шаблон:** "Доска"
**Атрибуты:**
- `length` (6000) - формульный, тип: number
- `width` (200) - формульный, тип: number  
- `height` (50) - формульный, тип: number
- `grade` (1 сорт) - обычный, тип: select
- `producer` (ООО Лесопилка) - обычный, тип: text

**Результат:** `Доска: 6000 x 200 x 50, 1 сорт, ООО Лесопилка`

### Пример 2: Только формульные атрибуты

**Шаблон:** "Профиль"
**Атрибуты:**
- `length` (3000) - формульный, тип: number
- `width` (40) - формульный, тип: number
- `height` (40) - формульный, тип: number

**Результат:** `Профиль: 3000 x 40 x 40`

### Пример 3: Только обычные атрибуты

**Шаблон:** "Крепеж"
**Атрибуты:**
- `type` (Саморез) - обычный, тип: select
- `material` (Нержавеющая сталь) - обычный, тип: select
- `coating` (Оцинкованный) - обычный, тип: select

**Результат:** `Крепеж: Саморез, Нержавеющая сталь, Оцинкованный`

### Пример 4: Смешанные атрибуты с текстовыми

**Шаблон:** "Труба"
**Атрибуты:**
- `diameter` (100) - формульный, тип: number
- `length` (6000) - формульный, тип: number
- `material` (Сталь) - обычный, тип: select
- `description` (Водопроводная) - текстовый, тип: text (игнорируется)

**Результат:** `Труба: 100 x 6000, Сталь`

## Особенности реализации

### 1. Игнорирование текстовых атрибутов
Текстовые атрибуты (`type = 'text'`) не участвуют в формировании имени, так как они предназначены для описания, а не для идентификации.

### 2. Нормализация числовых значений
```php
// Замена запятой на точку для корректной обработки
$normalizedValue = is_string($value) ? str_replace(',', '.', $value) : $value;
```

### 3. Разделители
- **Формульные атрибуты:** ` x ` (пробел-икс-пробел)
- **Обычные атрибуты:** `, ` (запятая-пробел)
- **Разделение групп:** `: ` (двоеточие-пробел) или `, ` (запятая-пробел)

### 4. Fallback значения
```php
$templateName = $template->name ?? 'Товар';
$name = $generatedName ?? 'Товар без названия';
```

## Места применения

### 1. API контроллеры
- `ProductController::store()` - при создании товара
- `ReceiptController::store()` - при создании товара в пути

### 2. Filament формы
- `ProductResource` - при изменении атрибутов в форме
- `ReceiptResource` - при создании товаров в пути
- `ProductInTransitResource` - при работе с товарами в пути

### 3. Автоматическое обновление
Имя пересчитывается автоматически при изменении любого атрибута через:
- `afterStateUpdated()` callback в Filament формах
- `live(onBlur: true)` для реального времени

## Структура данных

### ProductTemplate
```php
[
    'id' => 1,
    'name' => 'Доска',
    'formula' => 'length * width * height / 1000000000',
    'unit' => 'м³'
]
```

### ProductAttribute
```php
[
    'id' => 1,
    'product_template_id' => 1,
    'name' => 'Длина',
    'variable' => 'length',
    'type' => 'number',
    'unit' => 'мм',
    'is_required' => true,
    'is_in_formula' => true,
    'sort_order' => 1
]
```

### Входные данные атрибутов
```php
[
    'attributes' => [
        'length' => '6000',
        'width' => '200',
        'height' => '50',
        'grade' => '1 сорт',
        'producer' => 'ООО Лесопилка'
    ]
]
```

## Обработка ошибок

### 1. Отсутствие шаблона
```php
if (!$template) {
    return 'Товар без названия';
}
```

### 2. Пустые атрибуты
```php
if (empty($formulaParts) && empty($regularParts)) {
    return $template->name ?? 'Товар';
}
```

### 3. Некорректные значения
- Пустые строки игнорируются
- Null значения игнорируются
- Текстовые атрибуты исключаются

## Конфигурация

### Настройка атрибутов в админке
1. **Создание шаблона** - базовое название товара
2. **Добавление атрибутов** - характеристики с настройками:
   - `is_in_formula` - участие в формуле и имени
   - `is_required` - обязательность заполнения
   - `type` - тип данных
   - `sort_order` - порядок отображения

### Пример настройки атрибутов
```php
// Формульные атрибуты (для расчета объема)
[
    'name' => 'Длина',
    'variable' => 'length',
    'type' => 'number',
    'is_in_formula' => true,
    'is_required' => true
]

// Обычные атрибуты (для описания)
[
    'name' => 'Сорт',
    'variable' => 'grade',
    'type' => 'select',
    'is_in_formula' => false,
    'is_required' => false
]
```

## Заключение

Система автоматического формирования имен товаров обеспечивает:
- **Консистентность** - единообразные названия
- **Читаемость** - понятная структура
- **Гибкость** - настройка под разные типы товаров
- **Автоматизацию** - минимум ручного ввода

Алгоритм учитывает специфику разных типов товаров и создает информативные названия, которые легко читать и понимать пользователям системы.
